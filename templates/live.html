<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Placetel AI – Live</title>
  <script src="https://unpkg.com/@webex/embedded-app-sdk@2"></script>
  <link rel="stylesheet" href="/static/app.css">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>

<body class="page">
  <div class="topbar">
    <button id="tabLive" class="tab tab--active">Live</button>
    <button id="tabHist" class="tab">History</button>
    <button id="tabAuth" class="tab" style="display:none">Authorization</button>
    <span id="userInfo" style="margin-left: auto; font-size: 12px; color: #9aa7bd;"></span>
  </div>

  <div class="container">
    <section id="viewLive" class="card">
      <header class="livehdr">
        <div class="livehdr__title" id="liveHeader">Waiting for calls...</div>
        <div class="livehdr__sub" id="liveSub"></div>
        <div class="badge">Live</div>
        <div id="liveEq" class="eq eq--hidden" aria-hidden="true">
          <div class="eq__bar"></div>
          <div class="eq__bar"></div>
          <div class="eq__bar"></div>
          <div class="eq__bar"></div>
          <div class="eq__bar"></div>
        </div>
      </header>

      <div id="liveTx" class="tx hidden"></div>

      <div id="liveIdle" class="empty">
        <img class="pulse" src="/static/bot.png" alt="AI bot">
        <div>AI patiently waiting for calls.</div>
      </div>

      <div id="pickupContainer" class="hidden" style="margin-top: 16px; text-align: center;">
        <button id="btnPickup" style="padding: 12px 24px; background: #18e299; color: #0b1020; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
          Pick Up Call
        </button>
      </div>
    </section>
  </div>

  <script>
    let webexApp = null;
    let currentUserId = null;
    let currentUserInfo = null;
    let isAdmin = false;
    let socket = null;
    let currentCall = null;

    (async function initWebex() {
      if (!window.Webex || !window.Webex.Application) {
        console.error('Webex SDK v2 not loaded');
        return;
      }

      webexApp = new window.Webex.Application();
      await webexApp.onReady();
      await webexApp.listen();

      const response = await fetch('/api/auth/me');
      if (response.ok) {
        currentUserInfo = await response.json();
        currentUserId = currentUserInfo.id;
        document.getElementById('userInfo').textContent = currentUserInfo.displayName || currentUserInfo.emails?.[0] || 'User';

        // Check if user is admin: show Authorization tab if they can access users list
        // This works for account owners, not just Full_Admin/User_Admin roles
        try {
          const usersCheck = await fetch('/api/users/list');
          if (usersCheck.ok) {
            document.getElementById('tabAuth').style.display = 'block';
            isAdmin = true;
          }
        } catch (e) {
          // Not admin, that's fine
        }

        initSocket();
      }

      webexApp.on('application:callStateChanged', handleCallStateChange);
    })();

    function handleCallStateChange(call) {
      const state = (call?.state || 'unknown').toLowerCase();
      const remoteNumber = getRemoteNumber(call);
      const localNumber = getLocalNumber(call);
      const displayName = call.remoteParticipants?.[0]?.name || call.caller?.name || call.displayName || '';

      fetch('/simulate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          event: state,
          call_id: call.id,
          remoteNumber,
          localNumber,
          displayName
        })
      }).catch(() => { });
    }

    function getLocalNumber(call = {}) {
      return (
        call.localParticipant?.phoneNumber ||
        call.localParticipant?.callerID ||
        call.to?.phoneNumber || call.to || ''
      );
    }

    function getRemoteNumber(call = {}) {
      const rps = Array.isArray(call.remoteParticipants)
        ? call.remoteParticipants
        : (call.remoteParticipant ? [call.remoteParticipant] : []);
      const local = getLocalNumber(call);

      const rp = rps.find(p => {
        const n = p?.phoneNumber || p?.callerID || '';
        return n && n !== local;
      });

      const candidate =
        rp?.phoneNumber ||
        rp?.callerID ||
        call.from?.phoneNumber || call.from ||
        call.caller?.phoneNumber || call.caller?.callerID ||
        call.displayName || '';

      return candidate && candidate !== local ? String(candidate).trim() : '';
    }

    function initSocket() {
      socket = io();
      socket.emit('join', { user_id: currentUserId });

      socket.on('incoming_call', handleIncomingCall);
      socket.on('call_assigned', handleCallAssigned);
      socket.on('call_removed', handleCallRemoved);
      socket.on('call_event', handleCallEvent);
    }

    function handleIncomingCall(data) {
      console.log('Incoming call:', data);
      currentCall = data;

      document.getElementById('liveHeader').textContent = data.caller || 'Unknown';
      document.getElementById('liveSub').textContent = 'Incoming call';

      setIdle(false);

      if (data.show_summary) {
        displayCallSummary(data.call_data);
        showEqualizer(true);
      } else {
        document.getElementById('liveTx').classList.add('hidden');
        document.getElementById('pickupContainer').classList.remove('hidden');
        document.getElementById('liveSub').textContent = 'Group call - pick up to see details';
      }
    }

    function handleCallAssigned(data) {
      console.log('Call assigned:', data);
      currentCall = data;

      displayCallSummary(data.call_data);
      showEqualizer(true);
      document.getElementById('pickupContainer').classList.add('hidden');
      document.getElementById('liveSub').textContent = 'Connected';
    }

    function handleCallRemoved(data) {
      console.log('Call removed:', data);
      if (currentCall && currentCall.call_id === data.call_id) {
        resetLiveView();
      }
    }

    function handleCallEvent(data) {
      console.log('Call event:', data);
      const state = (data.state || '').toLowerCase();

      // Handle call end
      if (state === 'ended' || state === 'completed' || state === 'hangup') {
        resetLiveView();
        return;
      }

      // For ANY active call, exit idle mode and show caller info
      setIdle(false);

      // Always show caller info if available
      if (data.remoteNumber || data.displayName || data.caller) {
        const label = data.remoteNumber || data.displayName || data.caller || 'Unknown';
        document.getElementById('liveHeader').textContent = label;
        document.getElementById('liveSub').textContent = `State: ${state}`;
      }

      // Show equalizer when connected
      if (state === 'connected') {
        showEqualizer(true);

        // If no AI summary was received, show placeholder
        if (!currentCall || !currentCall.call_data) {
          showNoSummaryPlaceholder();
        }
      }

      // Add transcript lines if available
      if (data.transcript && data.transcript.trim()) {
        addConcernLines(data.transcript);
      }
    }

    function showNoSummaryPlaceholder() {
      const liveTx = document.getElementById('liveTx');
      liveTx.innerHTML = `
        <div style="display:flex;flex-direction:column;align-items:center;gap:16px;padding:40px 20px;color:#9aa7bd;">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            <line x1="9" y1="10" x2="15" y2="10"></line>
            <line x1="12" y1="7" x2="12" y2="13"></line>
          </svg>
          <div style="text-align:center;">
            <div style="font-weight:600;color:#e6eefb;margin-bottom:4px;">No AI-Summary Forwarded</div>
            <div style="font-size:13px;">This call was not forwarded from an AI assistant.</div>
          </div>
        </div>
      `;
      liveTx.classList.remove('hidden');
      document.getElementById('liveIdle').classList.add('hidden');
    }

    function displayCallSummary(callData) {
      if (!callData) return;

      const liveTx = document.getElementById('liveTx');
      liveTx.innerHTML = `
        <div class="tx-card" aria-live="polite" aria-atomic="false">
          <div class="tx-grid">
            <div class="tx-field">
              <div class="tx-label">Kunde</div>
              <div id="fldName" class="tx-value">${escapeHtml(callData.customer_name || '—')}</div>
            </div>
            <div class="tx-field">
              <div class="tx-label">Rückrufnummer</div>
              <div id="fldNumber" class="tx-value">${escapeHtml(callData.customer_number || '—')}</div>
            </div>
            <div class="tx-field">
              <div class="tx-label">Email</div>
              <div id="fldEmail" class="tx-value">${escapeHtml(callData.customer_email || '—')}</div>
            </div>
            <div class="tx-field">
              <div class="tx-label">Agent</div>
              <div id="fldAgent" class="tx-value">${escapeHtml(callData.agent_name || '—')}</div>
            </div>
            <div class="tx-field tx-section">
              <div class="tx-label">Anliegen</div>
              <ul id="listConcerns" class="tx-list" role="log">
                ${(callData.concerns || []).map(c => `<li>${escapeHtml(c)}</li>`).join('')}
              </ul>
            </div>
            <div class="tx-field tx-section">
              <div class="tx-label">Tasks</div>
              <ul id="listTasks" class="tx-list" role="log">
                ${(callData.tasks || []).map(t => `<li>${escapeHtml(t)}</li>`).join('')}
              </ul>
            </div>
          </div>
        </div>
      `;

      document.getElementById('liveIdle').classList.add('hidden');
      liveTx.classList.remove('hidden');
    }

    function addConcernLines(text) {
      if (!text || !text.trim()) return;
      const list = document.getElementById('listConcerns');
      if (!list) return;

      const parts = text.split(/\n+|(?<=[.!?])\s+(?=[A-ZÄÖÜ])/).map(s => s.trim()).filter(Boolean);
      for (const p of parts) {
        const li = document.createElement('li');
        li.textContent = p;
        list.appendChild(li);
      }

      const liveTx = document.getElementById('liveTx');
      liveTx.scrollTop = liveTx.scrollHeight;
    }

    function escapeHtml(s) {
      return String(s ?? '').replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
    }

    function setIdle(isIdle) {
      const liveIdle = document.getElementById('liveIdle');
      const liveTx = document.getElementById('liveTx');
      const pickupContainer = document.getElementById('pickupContainer');

      if (isIdle) {
        liveIdle.classList.remove('hidden');
        liveTx.classList.add('hidden');
        pickupContainer.classList.add('hidden');
        showEqualizer(false);
        document.getElementById('liveHeader').textContent = 'Waiting for calls...';
        document.getElementById('liveSub').textContent = '';
      } else {
        liveIdle.classList.add('hidden');
      }
    }

    function showEqualizer(show) {
      const liveEq = document.getElementById('liveEq');
      if (show) {
        liveEq.classList.remove('eq--hidden');
      } else {
        liveEq.classList.add('eq--hidden');
      }
    }

    function resetLiveView() {
      currentCall = null;
      setIdle(true);
    }

    document.getElementById('btnPickup').addEventListener('click', async () => {
      if (!currentCall || !currentUserId) return;

      const response = await fetch('/api/call/pickup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          call_id: currentCall.call_id,
          user_id: currentUserId
        })
      });

      if (response.ok) {
        document.getElementById('liveSub').textContent = 'Connecting...';
      }
    });

    document.getElementById('tabLive').addEventListener('click', () => {});

    document.getElementById('tabHist').addEventListener('click', () => {
      window.location.href = '/history';
    });

    document.getElementById('tabAuth').addEventListener('click', () => {
      window.location.href = '/authorization';
    });

    setIdle(true);
  </script>
</body>
</html>
