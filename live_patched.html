<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Placetel AI – Live</title>
  <script src="https://unpkg.com/@webex/embedded-app-sdk@2"></script>
  <link rel="stylesheet" href="/static/app.css">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>

<body class="page">
  <div class="topbar">
    <button id="tabLive" class="tab tab--active">Live</button>
    <button id="tabHist" class="tab">History</button>
    <button id="tabAuth" class="tab">Authorization</button>
    <span id="userInfo" style="margin-left: auto; font-size: 12px; color: #9aa7bd;"></span>
  </div>

  <div class="container">
    <section id="viewLive" class="card">
      <header class="livehdr">
        <div class="livehdr__title" id="liveHeader">Waiting for calls...</div>
        <div class="livehdr__sub" id="liveSub"></div>
        <div class="badge">Live</div>
        <div id="liveEq" class="eq eq--hidden" aria-hidden="true">
          <div class="eq__bar"></div>
          <div class="eq__bar"></div>
          <div class="eq__bar"></div>
          <div class="eq__bar"></div>
          <div class="eq__bar"></div>
        </div>
      </header>

      <div id="liveTx" class="tx hidden"></div>

      <div id="liveIdle" class="empty">
        <img class="pulse" src="/static/bot.png" alt="AI bot">
        <div>AI patiently waiting for calls.</div>
      </div>

      <div id="pickupContainer"
     class="hidden oj-sm-margin-top-2x oj-sm-text-align-center">
  <button id="btnPickup"
          class="oj-sm-padding-2x oj-sm-padding-horizontal-4x"
          style="background:#18e299;color:#0b1020;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
    Pick Up Call
  </button>
</div>
    </section>
  </div>

  <script>
    let webexApp = null;
    let currentUserId = null;
    let currentUserInfo = null;
    let isAdmin = false;
    let socket = null;
    let currentCall = null;

    (async function initWebex() {
      if (!window.Webex || !window.Webex.Application) {
        console.error('Webex SDK v2 not loaded - Are you opening this inside Webex?');
        console.error('This app must be opened as an embedded app within Webex, not directly in a browser.');

        // Show error message to user
        document.getElementById('liveHeader').textContent = '⚠️ SDK Not Loaded';
        document.getElementById('liveSub').innerHTML = 'This app must be opened <strong>inside Webex</strong>, not in a regular browser.<br>Open Webex → Apps → Your Embedded App';
        document.getElementById('liveIdle').classList.add('hidden');

        // Still try to initialize other features (history might work)
        tryInitializeWithoutSDK();
        return;
      }

      console.log('[INIT] Creating Webex Application instance...');
      webexApp = window.webex ? new window.webex.Application() : new window.Webex.Application();

      console.log('[INIT] Waiting for SDK to be ready...');
      await webexApp.onReady();
      console.log('[INIT] SDK is ready!');

      console.log('[INIT] Starting to listen for events...');
      await webexApp.listen();
      console.log('[INIT] Now listening for events!');


      // Get current Webex user directly from SDK v2 (no backend auth)
      const user = webexApp.application?.states?.user;
      if (user && user.id) {
        currentUserInfo = user;
        currentUserId = user.id;
        document.getElementById('userInfo').textContent =
          user.displayName || (user.emails && user.emails[0]) || 'User';
      } else {
        console.warn('[INIT] No user from SDK, using fallback id');
        currentUserInfo = { id: 'dev-user', displayName: 'Local Dev User', emails: ['dev@example.com'] };
        currentUserId = currentUserInfo.id;
        document.getElementById('userInfo').textContent = currentUserInfo.displayName;
      }

      // Initialize sockets for AI summaries (independent from call detection)
      initSocket();


      // Listen to ALL possible call events for debugging
      console.log('[INIT] Registering call event listeners...');

      // Try multiple event names (SDK v2 might use different names)
      const callEvents = [
        'application:callStateChanged',
        'application:incomingCall',
        'application:outgoingCall',
        'application:activeCall',
        'call:stateChanged',
        'call:incoming',
        'call:connected',
        'call:disconnected'
      ];

      callEvents.forEach(eventName => {
        webexApp.on(eventName, (call) => {
          console.log(`[EVENT] ${eventName}`, call);
          handleCallStateChange(call);
        });
      });

      console.log('[INIT] Call event listeners registered for:', callEvents);

      // BACKUP METHOD: Poll for active calls every 2 seconds
      console.log('[INIT] Starting call polling backup method...');
      let lastCallId = null;

      setInterval(async () => {
        try {
          // Try to get context which includes call info
          const context = await webexApp.context.getUser();
          console.log('[POLL] User context:', context);

          // Check if there's an active call
          if (window.Webex && window.Webex.calling) {
            const calls = window.Webex.calling.getCalls();
            console.log('[POLL] Active calls:', calls);

            if (calls && calls.length > 0) {
              const activeCall = calls[0];
              if (activeCall.id !== lastCallId) {
                console.log('[POLL] NEW CALL DETECTED!', activeCall);
                lastCallId = activeCall.id;
                handleCallStateChange(activeCall);
              }
            } else if (lastCallId) {
              // Call ended
              console.log('[POLL] Call ended');
              lastCallId = null;
              resetLiveView();
            }
          }
        } catch (e) {
          // Silently ignore polling errors
        }
      }, 2000);

      console.log('[INIT] Call polling started');
    })();

    
    async function tryInitializeWithoutSDK() {
      // Fallback path when SDK v2 is not available (local browser testing)
      try {
        console.warn('[INIT] SDK not available, using dev fallback user');
        currentUserInfo = { id: 'dev-user', displayName: 'Local Dev User', emails: ['dev@example.com'] };
        currentUserId = currentUserInfo.id;
        document.getElementById('userInfo').textContent = currentUserInfo.displayName;

        // Initialize socket even without Webex SDK
        initSocket();
      } catch (e) {
        console.error('Could not initialize without SDK:', e);
      }
    }

    function handleCallStateChange(call) {
      const state = (call?.state || 'unknown').toLowerCase();
      const remoteNumber = getRemoteNumber(call);
      const localNumber = getLocalNumber(call);
      const displayName = call.remoteParticipants?.[0]?.name || call.caller?.name || call.displayName || '';

      console.log('[CALL] State changed:', { state, remoteNumber, localNumber, displayName, currentUserId });

      const payload = {
        event: state,
        call_id: call.id,
        remoteNumber,
        localNumber,
        displayName,
        user_id: currentUserId  // Add user ID so server knows who to emit to
      };

      console.log('[CALL] Sending to /simulate:', payload);

      fetch('/simulate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(response => {
        console.log('[CALL] /simulate response:', response.status, response.ok);
        return response.json();
      })
      .then(data => {
        console.log('[CALL] /simulate result:', data);
      })
      .catch(err => {
        console.error('[CALL] Simulate error:', err);
      });
    }

    function getLocalNumber(call = {}) {
      return (
        call.localParticipant?.phoneNumber ||
        call.localParticipant?.callerID ||
        call.to?.phoneNumber || call.to || ''
      );
    }

    function getRemoteNumber(call = {}) {
      const rps = Array.isArray(call.remoteParticipants)
        ? call.remoteParticipants
        : (call.remoteParticipant ? [call.remoteParticipant] : []);
      const local = getLocalNumber(call);

      const rp = rps.find(p => {
        const n = p?.phoneNumber || p?.callerID || '';
        return n && n !== local;
      });

      const candidate =
        rp?.phoneNumber ||
        rp?.callerID ||
        call.from?.phoneNumber || call.from ||
        call.caller?.phoneNumber || call.caller?.callerID ||
        call.displayName || '';

      return candidate && candidate !== local ? String(candidate).trim() : '';
    }

    function initSocket() {
      console.log('[SOCKET] Connecting to Socket.IO...');
      socket = io();

      socket.on('connect', () => {
        console.log('[SOCKET] Connected! Socket ID:', socket.id);
        console.log('[SOCKET] Joining room for user:', currentUserId);
        socket.emit('join', { user_id: currentUserId });
      });

      socket.on('disconnect', () => {
        console.log('[SOCKET] Disconnected!');
      });

      socket.on('error', (error) => {
        console.error('[SOCKET] Error:', error);
      });

      socket.on('incoming_call', (data) => {
        console.log('[SOCKET] incoming_call event received:', data);
        handleIncomingCall(data);
      });

      socket.on('call_assigned', (data) => {
        console.log('[SOCKET] call_assigned event received:', data);
        handleCallAssigned(data);
      });

      socket.on('call_removed', (data) => {
        console.log('[SOCKET] call_removed event received:', data);
        handleCallRemoved(data);
      });

      socket.on('call_event', (data) => {
        console.log('[SOCKET] call_event event received:', data);
        handleCallEvent(data);
      });

      console.log('[SOCKET] All event listeners registered');
    }

    function handleIncomingCall(data) {
      console.log('Incoming call:', data);
      currentCall = data;

      document.getElementById('liveHeader').textContent = data.caller || 'Unknown';
      document.getElementById('liveSub').textContent = 'Incoming call';

      setIdle(false);

      if (data.show_summary) {
        displayCallSummary(data.call_data);
        showEqualizer(true);
      } else {
        document.getElementById('liveTx').classList.add('hidden');
        document.getElementById('pickupContainer').classList.remove('hidden');
        document.getElementById('liveSub').textContent = 'Group call - pick up to see details';
      }
    }

    function handleCallAssigned(data) {
      console.log('Call assigned:', data);
      currentCall = data;

      displayCallSummary(data.call_data);
      showEqualizer(true);
      document.getElementById('pickupContainer').classList.add('hidden');
      document.getElementById('liveSub').textContent = 'Connected';
    }

    function handleCallRemoved(data) {
      console.log('Call removed:', data);
      if (currentCall && currentCall.call_id === data.call_id) {
        resetLiveView();
      }
    }

    function handleCallEvent(data) {
      console.log('[HANDLER] handleCallEvent called with:', data);
      const state = (data.state || '').toLowerCase();
      console.log('[HANDLER] Call state:', state);

      // Handle call end
      if (state === 'ended' || state === 'completed' || state === 'hangup') {
        console.log('[HANDLER] Call ended, resetting view');
        resetLiveView();
        return;
      }

      // For ANY active call, exit idle mode and show caller info
      console.log('[HANDLER] Exiting idle mode');
      setIdle(false);

      // Always show caller info if available
      if (data.remoteNumber || data.displayName || data.caller) {
        const label = data.remoteNumber || data.displayName || data.caller || 'Unknown';
        console.log('[HANDLER] Showing caller:', label);
        document.getElementById('liveHeader').textContent = label;
        document.getElementById('liveSub').textContent = `State: ${state}`;
      } else {
        console.log('[HANDLER] No caller info in data');
      }

      // Show equalizer when connected
      if (state === 'connected') {
        console.log('[HANDLER] Call connected, showing equalizer');
        showEqualizer(true);

        // If no AI summary was received, show placeholder
        if (!currentCall || !currentCall.call_data) {
          console.log('[HANDLER] No AI summary, showing placeholder');
          showNoSummaryPlaceholder();
        }
      }

      // Add transcript lines if available
      if (data.transcript && data.transcript.trim()) {
        console.log('[HANDLER] Adding transcript lines');
        addConcernLines(data.transcript);
      }
    }

    function showNoSummaryPlaceholder() {
      const liveTx = document.getElementById('liveTx');
      liveTx.innerHTML = `
        <div style="display:flex;flex-direction:column;align-items:center;gap:16px;padding:40px 20px;color:#9aa7bd;">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            <line x1="9" y1="10" x2="15" y2="10"></line>
            <line x1="12" y1="7" x2="12" y2="13"></line>
          </svg>
          <div style="text-align:center;">
            <div style="font-weight:600;color:#e6eefb;margin-bottom:4px;">No AI-Summary Forwarded</div>
            <div style="font-size:13px;">This call was not forwarded from an AI assistant.</div>
          </div>
        </div>
      `;
      liveTx.classList.remove('hidden');
      document.getElementById('liveIdle').classList.add('hidden');
    }

    function displayCallSummary(callData) {
      if (!callData) return;

      const liveTx = document.getElementById('liveTx');
      liveTx.innerHTML = `
        <div class="tx-card" aria-live="polite" aria-atomic="false">
          <div class="tx-grid">
            <div class="tx-field">
              <div class="tx-label">Kunde</div>
              <div id="fldName" class="tx-value">${escapeHtml(callData.customer_name || '—')}</div>
            </div>
            <div class="tx-field">
              <div class="tx-label">Rückrufnummer</div>
              <div id="fldNumber" class="tx-value">${escapeHtml(callData.customer_number || '—')}</div>
            </div>
            <div class="tx-field">
              <div class="tx-label">Email</div>
              <div id="fldEmail" class="tx-value">${escapeHtml(callData.customer_email || '—')}</div>
            </div>
            <div class="tx-field">
              <div class="tx-label">Agent</div>
              <div id="fldAgent" class="tx-value">${escapeHtml(callData.agent_name || '—')}</div>
            </div>
            <div class="tx-field tx-section">
              <div class="tx-label">Anliegen</div>
              <ul id="listConcerns" class="tx-list" role="log">
                ${(callData.concerns || []).map(c => `<li>${escapeHtml(c)}</li>`).join('')}
              </ul>
            </div>
            <div class="tx-field tx-section">
              <div class="tx-label">Tasks</div>
              <ul id="listTasks" class="tx-list" role="log">
                ${(callData.tasks || []).map(t => `<li>${escapeHtml(t)}</li>`).join('')}
              </ul>
            </div>
          </div>
        </div>
      `;

      document.getElementById('liveIdle').classList.add('hidden');
      liveTx.classList.remove('hidden');
    }

    function addConcernLines(text) {
      if (!text || !text.trim()) return;
      const list = document.getElementById('listConcerns');
      if (!list) return;

      const parts = text.split(/\n+|(?<=[.!?])\s+(?=[A-ZÄÖÜ])/).map(s => s.trim()).filter(Boolean);
      for (const p of parts) {
        const li = document.createElement('li');
        li.textContent = p;
        list.appendChild(li);
      }

      const liveTx = document.getElementById('liveTx');
      liveTx.scrollTop = liveTx.scrollHeight;
    }

    function escapeHtml(s) {
      return String(s ?? '').replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
    }

    function setIdle(isIdle) {
      const liveIdle = document.getElementById('liveIdle');
      const liveTx = document.getElementById('liveTx');
      const pickupContainer = document.getElementById('pickupContainer');

      if (isIdle) {
        liveIdle.classList.remove('hidden');
        liveTx.classList.add('hidden');
        pickupContainer.classList.add('hidden');
        showEqualizer(false);
        document.getElementById('liveHeader').textContent = 'Waiting for calls...';
        document.getElementById('liveSub').textContent = '';
      } else {
        liveIdle.classList.add('hidden');
      }
    }

    function showEqualizer(show) {
      const liveEq = document.getElementById('liveEq');
      if (show) {
        liveEq.classList.remove('eq--hidden');
      } else {
        liveEq.classList.add('eq--hidden');
      }
    }

    function resetLiveView() {
      currentCall = null;
      setIdle(true);
    }

    document.getElementById('btnPickup').addEventListener('click', async () => {
      if (!currentCall || !currentUserId) return;

      const response = await fetch('/api/call/pickup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          call_id: currentCall.call_id,
          user_id: currentUserId
        })
      });

      if (response.ok) {
        document.getElementById('liveSub').textContent = 'Connecting...';
      }
    });

    document.getElementById('tabLive').addEventListener('click', () => {});

    document.getElementById('tabHist').addEventListener('click', () => {
      window.location.href = '/history';
    });

    document.getElementById('tabAuth').addEventListener('click', () => {
      window.location.href = '/authorization';
    });

    setIdle(true);
  </script>
</body>
</html>
